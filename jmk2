#!/usr/bin/make -f

MAKEFLAGS += -Rr --warn-undefined-variables
SHELL != which bash
.DEFAULT_GOAL :=  main

.DELETE_ON_ERROR:

git.test != git rev-parse --is-inside-work-tree > /dev/null 2>&1 && date
. := $(or $(git.test),$(error not in a git dir))
git.dir != git rev-parse --git-dir
git.exclude := $(git.dir)/info/exclude

tmp := .mk
ext ?= ext2
self := $(lastword $(MAKEFILE_LIST))
file ?= jmk2

adam := $(tmp)/.adam
ultimo := /proc/self
$(ultimo):;
$(adam):; touch -d @0 $@
old-or-young := && echo $(adam) || echo $(ultimo)
lineinfile = $(eval $2:: $(shell grep -q '$1' $2 $(old-or-young)); echo '$1' >> $$@)

dirs := $(tmp) $(ext)
stones := $(dirs:%=%/.stone)
stones: $(stones)
.PHONY: stones
$(self): $(stones) $(adam)
%/.stone:; mkdir -p $(@D); touch $@
$(call lineinfile,$(tmp),$(git.exclude))
$(call lineinfile,$(ext),$(git.exclude))

$(self): $(tmp)/$(file).mk;
include $(tmp)/$(file).mk

yml2js.py := import sys, yaml, json;
yml2js.py += json.dump(yaml.load(sys.stdin), sys.stdout, indent=2, default=str, sort_keys=True)

yml2js := python -c '$(yml2js.py)'

$(file).yml types.jq config.jq git.jq:;

out := $(tmp)/$(file)

$(out).js: $(file).yml; @ < $< $(yml2js) > $@

$(out).mk: types.jq default.jq mk.jq
$(out).mk: $(out).js; < $< jq -f types.jq | jq -f default.jq | jq -f mk.jq -r > $@

main:; @echo $(git.items)
.PHONY: main

gitkey = $(config.$(git.$1.conf).key)

ifneq ($(ext),.)
$(git.items): % : $(ext)/%
.PHONY: $(git.items)
endif
$(git.items:%=%/clone): %/clone: $(ext)/%
gitdirs := $(git.items:%=$(ext)/%)
$(gitdirs): ssh = GIT_SSH_COMMAND='ssh -i ~/.ssh/$(call gitkey,$(@F))'
$(gitdirs):; $(ssh) git clone -b $(git.$(@F).version) $(git.$(@F).git) $(ext)/$(@F)
clone: $(gitdirs)
.PHONY: clone 

$(git.items:%=%/pull): %/pull: %/key; git -C $(ext)/$* $(@F)
pull: $(git.items:%=%/pull)
.PHONY: pull

define config
$1_$2.dep  = test -d $(ext)/$1 &&
$1_$2.dep += git -C $(ext)/$1 config --local $2 > /dev/null || echo $1_$2/do_conf
$1_$2.cmd  = git -C $(ext)/$1 config --add $2 "$(config.$(git.$(repo).conf).configs.$2)"
$1_$2/conf: $$(shell $$($1_$2.dep))
$1_$2/do_conf:; $$($1_$2.cmd)
$1_conf += $1_$2/conf
.PHONY: $1_$2/conf $1_$2/do_conf
endef

. := $(foreach repo, $(git.items), \
	$(foreach conf, \
		$(config.$(git.$(repo).conf).configs.items), \
		$(eval $(call config,$(repo),$(conf)))))

, := $(foreach repo, $(git.items), $(eval $(repo)/conf: $($(repo)_conf)))

conf: clone $(git.items:%=%/conf)
.PHONY: conf $(git.items:%=%/conf)

exclude: $(git.exclude)

clean:; rm $(out).js
.PHONY: clean

.SECONDEXPANSION:

gitkeys.dep  = test -d $(ext)/$* &&
gitkeys.dep += git -C $(ext)/$* config core.sshCommand > /dev/null || echo $*/do_key
$(git.items:%=%/key): %/key: % $$(shell $$(gitkeys.dep))
dokey := $(git.items:%=%/do_key)
$(dokey): ssh = "ssh -i ~/.ssh/$(call gitkey,$*) -F /dev/null"
$(dokey): config = config --add core.sshCommand $(ssh)
$(dokey): %/do_key:; git -C $(ext)/$* $(config)
